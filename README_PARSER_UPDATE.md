# 中文质检报告OCR解析器 - 修复说明

## 问题诊断

用户上传的PDF (`20260122_111541.pdf`) 包含3个检验位置的测量数据：
- 位置1: 27.80+0.10-0.00mm → 数据: 27.85, 27.84, 27.81...
- 位置11: Φ6.00±0.10mm → 数据: 6.02, 6.02, 6.01...
- 位置13: 73.20+0.00-0.15mm → 数据: 73.14, 73.12, 73.15...

但App显示的是mock数据（2.4xx, 5.0xx），不是真实PDF内容。

## 根本原因

原始的`_parse_markdown_to_json()`函数太简单，无法处理复杂的中文质检报告格式：
1. 无法分离多个检验位置（混在一起）
2. 无法正确解析中文规格格式（27.80+0.10-0.00, Φ6.00±0.10）
3. 无法识别OK/NG判定列
4. 列索引计算错误

## 解决方案

### 1. 新增专用解析器 `_parse_chinese_qc_report()`

功能：
- 识别中文表头（检验位置、检验标准、结果、序号）
- 解析多种规格格式：
  - 不对称公差：`27.80+0.10-0.00` → USL=27.9, LSL=27.8
  - 对称公差：`Φ6.00±0.10` → USL=6.1, LSL=5.9
  - 负向公差：`73.20+0.00-0.15` → USL=73.2, LSL=73.05
- 提取多个检验位置的测量数据
- 自动识别直径符号（Φ）

### 2. 测试结果

```
✅ 位置1: USL=27.9, LSL=27.8, Mean=27.833 (10个数据点)
✅ 位置11: USL=6.1, LSL=5.9, Mean=6.026 (10个数据点)
✅ 位置13: USL=73.2, LSL=73.05, Mean=73.144 (10个数据点)
```

### 3. 使用方法

上传中文质检PDF后，系统会自动：
1. 使用MinerU OCR提取markdown
2. 自动检测中文QC报告格式
3. 正确解析所有检验位置的规格和数据
4. 生成多个6SPC分析图表

### 4. 代码变更

文件：`src/ocr_service.py`

- 增强 `_parse_markdown_to_json()`：优先调用中文解析器
- 新增 `_parse_chinese_qc_report()`：198行，专门处理中文质检报告
- 保留 `_get_mock_data_multi()`：作为降级方案

## 下一步

1. 启动Streamlit应用测试真实PDF
2. 验证3个检验位置都能正确解析
3. 检查6SPC图表是否正确生成

```bash
python3 -m streamlit run src/verify_ui.py
```

然后在应用中上传 `Scan PDF/20260122_111541.pdf` 进行验证。
